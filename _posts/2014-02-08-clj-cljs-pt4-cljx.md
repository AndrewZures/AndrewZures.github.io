---
layout: post
title:  "Combining Clojure and ClojureScript Libraries - Part 4: Using CLJX"
date:   2014-02-08 09:57:27
categories: jekyll update
---

[8thLight]: https://8thlight.com
[speclj]:    https://github.com/slagyr/speclj 
[cljx]: https://github.com/lynaghk/cljx
[sample_project]: https://github.com/AndrewZures/combining_clj_cljs_libraries/tree/cljx

[part_1]: http://andrewzures.github.io/jekyll/update/2014/02/08/clj-cljs-pt1-context.html 
[part_2]: http://andrewzures.github.io/jekyll/update/2014/02/08/clj-cljs-pt2-setup.html
[part_3]: http://andrewzures.github.io/jekyll/update/2014/02/08/clj-cljs-pt3-dividing-profiles.html
[part_4]: http://andrewzures.github.io/jekyll/update/2014/02/08/clj-cljs-pt4-cljx.html
[part_5]: http://andrewzures.github.io/jekyll/update/2014/02/08/clj-cljs-pt5-platform.html
[part_6]: http://andrewzures.github.io/jekyll/update/2014/02/08/clj-cljs-pt6-platform-and-macros.html
[part_7]: http://andrewzures.github.io/jekyll/update/2014/02/08/clj-cljs-pt7-if-macros.html
[part_8]: http://andrewzures.github.io/jekyll/update/2014/02/08/clj-cljs-pt8-combining-profiles.html
[part_9]: http://andrewzures.github.io/jekyll/update/2014/02/08/clj-cljs-pt9-final-thoughts.html

Here is our continuing [Sample Project][sample_project] with working code up to this part (Part 4) of the tutorial.

#Working With CLJX:

Next, we'll use the [CLJX][cljx] library.  CLJX translates a `.cljx` files into separate `.cljs` and `.clj` files.  You can use small `#+cljs` an `#+clj` tags to differentiate which forms you would like included in which version.  In the 8th Light [Speclj][speclj] project, CLJX replaced our hand-rolled pre-compiler.  This gave us the benefit of relying on an open-source, updated dependency instead of our own program.  

However, CLJX comes with a few downsides.  First, you'll have to keep track of the status of your cljx results. If you make a change in a `.cljx` file and, for whatever reason, do not recompile the cljx folder, your changes will not appear in your `.clj` and `.cljs` files.  Second, You should be careful to not make changes to the generated `.clj` and `.cljs` files since they will be overridden the next time you generate your `cljx` output.  Third, if you're running a test autorunner, it will likely not pick up changes to .cljx files.

So CLJX comes with a cost, but it does allow you to keep a relatively similar code base for your Clojure and ClojureScript libraries.  

#Adding CLJX to your Project.clj

To add [CLJX][cljx] simply add `[com.keminglabs/cljx "0.3.1"]` to your general `:dependencies` map. You will then have to configure source and output paths in the `:cljx` key:

{% highlight clojure linenos %}
    :cljx {:builds [{:source-paths ["src/cljx"]
                     :output-path "target/generated/src/clj"
                     :rules :clj}
                    {:source-paths ["src/cljx"]
                     :output-path "target/generated/src/cljs"
                     :rules :cljs}
                    {:source-paths ["spec/cljx"]
                     :output-path "target/generated/spec/clj"
                     :rules :clj}
                    {:source-paths ["spec/cljx"]
                     :output-path "target/generated/spec/cljs"
                     :rules :cljs}]}
{% endhighlight %}

So now every `.cljx` file in our `src/cljx` folder will be translated to separate `.clj` and `.cljs` version, which will be stored in the `target/generated/src/` folder.

It also will help to add the cljx `hooks` so that cljx will automatically build your files when you attempt a normal leiningen command:

{% highlight clojure linenos %}
    :hooks [cljx.hooks]
{% endhighlight %}


#Configuring Your Source-Paths and Test-Paths

With cljx installed, we'll have to change our `source-paths` and `test-paths` so that they look for the files generated by cljx.

For your `:clj` profile, simply modify the paths like below:

{% highlight clojure linenos %}
   :clj {
          :source-paths ["src/clj", "target/generated/src/clj"]
          :test-paths ["spec/clj", "target/generated/spec/clj"]
   }
{% endhighlight %}

For your `:cljs` you new source and test resources will both go in `:source-paths` collection:


{% highlight clojure linenos %}
   {:source-paths ["src/cljs"
                   "spec/cljs"
                   "target/generated/src/cljs"
                   "target/generated/spec/cljs"]
          :compiler {:output-to "target/tests.js"
                     :pretty-print true}
          :notify-command run-specs}
{% endhighlight %}

#Making Things Easy with Aliases

We're almost done.  With cljx `hooks` in your `project.clj`, cljx will auto-generate files before you run you Clojure tests.  However, for ClojureScript we'll have to test leiningen to compile before we run tests.  We can do this easily by changing our `cljs-test` alias:


{% highlight clojure linenos %}
   :aliases { "cljs-test" ["do" "cljx," "with-profile" "cljs" "cljsbuild" "test"] }
{% endhighlight %}

We also are little more concerned about the `target` directory.  So we may want to clean that directory before regenerating our cljx code.  We can add a few aliases that help us with that:

{% highlight clojure linenos %}
    :aliases { "clj-clean-test" ["do" "clean," "clj-test"]
               "cljs-clean-test" ["do" "clean," "cljs-test"]
            }
{% endhighlight %}

Lastly, we can add a final alias that will run both our `clj` and `cljs` tests in one command:

{% highlight clojure linenos %}

    :aliases { "all-tests" ["do" "clean," "clj-test," "cljs-test"] }
{% endhighlight %}

Now our `project.clj` file is updated. We should now be able to add a `.cljx` file to our project and it will generate separate but similar `.clj` and `.cljs` files.

#Adding a .cljx File to your Project

If you are using the [sample project][sample_project] you'll see that we already have `src/clj/myproject/core.clj` and `src/cljs/myproject/core.cljs`.  We'll create a similar directory structure for the `.cljx` files.  


Let's make a `src/cljx/myproject/` folder and add `shared_file.cljx` to the new folder.  Next, let's make a `spec/cljx/myproject/` folder and add `shared_file_spec.cljx`.

In `shared_file.cljx` add:

{% highlight clojure linenos %}

(ns myproject.shared-file)

(defn multiply [x y]
  (* x y)
)

{% endhighlight %}
\*

In `shared_file_spec.cljx` add:

{% highlight clojure linenos %}

(ns myproject.shared-file-spec
  (#+clj :require #+cljs :require-macros [speclj.core :refer [describe it should=]])
  (:require [speclj.core]
            [myproject.shared-file :as shared-file]))

(describe "sample cljx file"

   (it "uses cljx files to generate tested code in clj an cljx"
      (should= 12 (shared-file/multiply 3 4)))
)

{% endhighlight %}


As you can see, the spec file includes `#+clj` and `#+cljs` tags. For this file, that means that cljx will add `:require` to the clojure version of the file and `:require-macros` to the Clojure version of the file.  These tags will include or exclude the entire form that follows them.  So one tag can include/exclude an entire function.


#Run our Tests with A CLJX file


Now that we have cljx set up and a `.cljx` file and test file, we can run `lein clj-clean-test` and `lein cljs-clean-test`.  Both should evaluate the `multiply` test included in the single `.cljx` file.


#Where We Are

Now we have a single `.cljx` source and spec file that will be generated into separate `.clj` and `.cljs` files.  And we can test our code in both Clojure and ClojureScript.  In [Part 5][part_5] we will finally get to writing some code that will help us build one functional source for Clojure and Clojurescript.

[Part 1: A Bit Of Context][part_1]

[Part 2: Setting Up Your Base Project][part_2]

[Part 3: Dividing Profiles][part_3]

[Part 4: Using CLJX][part_4]

[Part 5: Platform Files][part_5]

[Part 6: Platform Files and Macros][part_6]

[Part 7: Context Aware Macros][part_7]

[Part 8: One Jar to Rule Them All][part_8]

[Part 9: Final Thoughts][part_9]

----

For reference, here is (very) basic look at our project structure

{% highlight clojure %}
myproject
   |
   |--- test
   |     |--- clj
   |     |    |--- myproject
   |     |            |--- test-code.clj
   |     |--- cljs
   |     |     |--- myproject
   |     |             |--- test-code.cljs
   |     |--- cljx
   |           |--- myproject
   |                   |--- test-code.cljx
   |
   |--- src
         |--- clj
         |     |--- myproject
         |             |--- source-code.clj
         |--- cljs
         |     |--- myproject
         |             |--- source-code.cljs
         |--- cljx
               |--- myproject
                       |--- source-code.cljx




{% endhighlight %}


-----

For reference, here is a look at the final `project.clj` file:

{% highlight clojure linenos %}
(defproject myproject "0.1.0-SNAPSHOT"
  :description "Combining Clojure and ClojureScript Libraries"

    :dependencies [[org.clojure/clojure "1.5.1"]
                   [speclj "2.9.4"]
                   [com.keminglabs/cljx "0.3.1"]
                   ]]

    :plugins [[speclj "6.9.4"]]

    :aliases {  "clj-test" ["with-profile","clj","spec"]
                "clj-clean-test" ["do" "clean," "clj-test"]
                "cljs-test" ["with-profile","cljs", "cljsbuild", "test"]
                "cljs-clean-test" ["do" "clean," "cljs-test"]
                "all-tests" ["do" "clean," "clj-test," "cljs-test"]
            }


    :profiles {

         :clj {
                :source-paths ["src/clj", "target/generated/src/clj"]
                :test-paths ["spec/clj", "target/generated/spec/clj"]
         }

         :cljs {:dependencies [[org.clojure/clojurescript "0.0-2014"] ;necessary for current version of speclj
                               [org.clojure/tools.reader "0.7.10"] ;necessary for current version of speclj
                               [lein-cljsbuild "1.0.2"]]
               :plugins [[lein-cljsbuild "1.0.2"]]

               :cljsbuild ~(let [run-specs ["bin/speclj" "target/tests.js"]]
                   {:builds
                       {:dev {:source-paths ["src/cljs"
                                             "spec/cljs"
                                             "target/generated/src/cljs"
                                             "target/generated/spec/cljs"]
                              :compiler {:output-to "target/tests.js"
                                         :pretty-print true}
                              :notify-command run-specs}}
               :test-commands {"test" run-specs}})

              }
        }

    :hooks [cljx.hooks]
    :cljx {:builds [{:source-paths ["src/cljx"]
                     :output-path "target/generated/src/clj"
                     :rules :clj}
                    {:source-paths ["src/cljx"]
                     :output-path "target/generated/src/cljs"
                     :rules :cljs}
                    {:source-paths ["spec/cljx"]
                     :output-path "target/generated/spec/clj"
                     :rules :clj}
                    {:source-paths ["spec/cljx"]
                     :output-path "target/generated/spec/cljs"
                     :rules :cljs}]}

)
{% endhighlight %}
